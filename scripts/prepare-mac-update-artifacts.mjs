#!/usr/bin/env node

import { execFileSync } from "node:child_process";
import crypto from "node:crypto";
import { existsSync, mkdtempSync, readFileSync, rmSync, statSync, writeFileSync } from "node:fs";
import os from "node:os";
import path from "node:path";
import yaml from "js-yaml";

const APP_IDENTIFIER = "com.multichat.desktop";
const desktopDir = process.cwd();
const desktopPkgPath = path.join(desktopDir, "package.json");
const builderConfigPath = path.join(desktopDir, "electron-builder.yml");
const distDir = path.join(desktopDir, "dist");
const appPath = path.join(distDir, "mac-arm64", "MultiChat.app");
const zipPath = path.join(distDir, "MultiChat-mac.zip");
const dmgPath = path.join(distDir, "MultiChat-mac.dmg");
const zipBlockmapPath = path.join(distDir, "MultiChat-mac.zip.blockmap");
const dmgBlockmapPath = path.join(distDir, "MultiChat-mac.dmg.blockmap");
const ymlPath = path.join(distDir, "latest-mac.yml");

if (!existsSync(appPath)) {
  console.log("[mac-update] skipping: mac app bundle was not found");
  process.exit(0);
}

const appVersion = (() => {
  try {
    const pkg = JSON.parse(readFileSync(desktopPkgPath, "utf8"));
    return typeof pkg?.version === "string" && pkg.version.length > 0 ? pkg.version : "0.0.0";
  } catch {
    return "0.0.0";
  }
})();

const appUpdatePublishConfig = (() => {
  try {
    const parsed = yaml.load(readFileSync(builderConfigPath, "utf8"));
    if (parsed && typeof parsed === "object") {
      const publish = parsed.publish;
      const primary = Array.isArray(publish) ? publish[0] : publish;
      if (primary && typeof primary === "object") {
        return {
          ...primary,
          updaterCacheDirName: APP_IDENTIFIER
        };
      }
    }
  } catch {
    // fall through
  }

  return {
    provider: "github",
    owner: "mhdtech1",
    repo: "MultiChat",
    updaterCacheDirName: APP_IDENTIFIER
  };
})();

const tempDir = mkdtempSync(path.join(os.tmpdir(), "multichat-mac-release-"));
const stagedAppPath = path.join(tempDir, "MultiChat.app");
const verifyExtractDir = path.join(tempDir, "verify-extract");

const toSha512 = (filePath) => {
  const buffer = readFileSync(filePath);
  return crypto.createHash("sha512").update(buffer).digest("base64");
};

try {
  execFileSync("ditto", [appPath, stagedAppPath], { stdio: "inherit" });

  // Remove file-provider metadata and apply stable ad-hoc signing.
  execFileSync("xattr", ["-cr", stagedAppPath], { stdio: "inherit" });
  writeFileSync(
    path.join(stagedAppPath, "Contents", "Resources", "app-update.yml"),
    yaml.dump(appUpdatePublishConfig, { lineWidth: -1, noRefs: true }),
    "utf8"
  );
  execFileSync(
    "codesign",
    [
      "--force",
      "--deep",
      "--sign",
      "-",
      "--identifier",
      APP_IDENTIFIER,
      "--requirements",
      `=designated => identifier "${APP_IDENTIFIER}"`,
      stagedAppPath
    ],
    { stdio: "inherit" }
  );
  execFileSync("codesign", ["--verify", "--deep", "--strict", stagedAppPath], { stdio: "inherit" });

  rmSync(zipPath, { force: true });
  execFileSync("ditto", ["-c", "-k", "--sequesterRsrc", "--keepParent", stagedAppPath, zipPath], {
    stdio: "inherit"
  });

  rmSync(dmgPath, { force: true });
  execFileSync("hdiutil", ["create", "-volname", "MultiChat", "-srcfolder", stagedAppPath, "-ov", "-format", "UDZO", dmgPath], {
    stdio: "inherit"
  });

  // Remove stale blockmaps generated by electron-builder artifacts we replaced.
  rmSync(zipBlockmapPath, { force: true });
  rmSync(dmgBlockmapPath, { force: true });

  // Verify zip payload is still strictly signed after extraction.
  rmSync(verifyExtractDir, { recursive: true, force: true });
  execFileSync("mkdir", ["-p", verifyExtractDir], { stdio: "inherit" });
  execFileSync("ditto", ["-x", "-k", zipPath, verifyExtractDir], { stdio: "inherit" });
  execFileSync("codesign", ["--verify", "--deep", "--strict", path.join(verifyExtractDir, "MultiChat.app")], {
    stdio: "inherit"
  });

  const zipSha512 = toSha512(zipPath);
  const dmgSha512 = toSha512(dmgPath);
  const zipSize = statSync(zipPath).size;
  const dmgSize = statSync(dmgPath).size;

  const latestMac = {
    version: appVersion,
    files: [
      { url: "MultiChat-mac.zip", sha512: zipSha512, size: zipSize },
      { url: "MultiChat-mac.dmg", sha512: dmgSha512, size: dmgSize }
    ],
    path: "MultiChat-mac.zip",
    sha512: zipSha512,
    releaseDate: new Date().toISOString()
  };

  writeFileSync(ymlPath, yaml.dump(latestMac, { lineWidth: -1, noRefs: true }), "utf8");
  console.log("[mac-update] generated signed MultiChat-mac.zip/.dmg and refreshed latest-mac.yml");
} finally {
  rmSync(tempDir, { recursive: true, force: true });
}
